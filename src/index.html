<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <title>json test</title>
</head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<body>
  <form id="apiForm">
    <label for="input">Select Master VM, Gallery and Definition:</label><br>
    <div id="VMs"><p>Gold VMs</p>
      <select id="VMselector"></select>
    </div>
    <div id="Galleries"><p>Galleries</p>
      <select id="Galleryselector"></select>
    </div>
    <div id="Definitions"><p>Definitions</p>
      <select id="Definitionselector"></select>
    </div>
    <input type="submit" value="Submit">
    <p id="timerDisplay">Timer: 0</p>
    <p id="statusDisplay"></p>
  </form>



  <main>
    <p id="output"></p>
  </main>

  <script>
    function objectToQueryString(obj) {
    return Object.keys(obj)
        .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(obj[key]))
        .join('&');
    }

    document.getElementById('apiForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      let Selection = {
        //code : 'mJlmaDJRGgvURTHOzZV1N3Iboi25_wdiUiKkT7w_UhqZAzFutYUHUQ==',
        code : 'blahblahblah',
        VMName : json.VMs[VMselect.value].Name,
        VMResourceGroupName : json.VMs[VMselect.value].ResourceGroup,
        GalleryName : json.Galleries[Galleryselect.value].Name,
        GalleryResourceGroup : json.Galleries[Galleryselect.value].ResourceGroup,
        DefinitionName : json.Galleries[Galleryselect.value].Definitions[Definitionselect.value].Name
      };  
      
      let queryString = objectToQueryString(Selection);
      let seconds = 0;
      const timerDisplay = document.getElementById('timerDisplay');
      const statusDisplay = document.getElementById('statusDisplay');
      console.log(queryString);
      fetch('/api/orchestrators/imageorchestrator?' + queryString)
        .then(response => response.json())
        .then(data => {
          console.log(data.statusQueryGetUri);
          var statusUrl = encodeURIComponent(data.statusQueryGetUri);
          const statusfunction = '/api/FunctionStatus?code=blahblahblah&statusuri=' + statusUrl;
          let jobfinished = null;
          const timer = setInterval(() => {
            fetch(statusfunction)
              .then(response => response.json())
              .then(data => {
                console.log('customstatus:', data.customStatus)
                statusDisplay.textContent = data.customStatus
                if (data.output !== null) {
                    jobfinished = data.output;
                    console.log('jobfinished:', jobfinished);
                    document.getElementById('output').textContent = JSON.stringify(jobfinished);
                    clearInterval(timer);
                  } else {
                    seconds++;
                    timerDisplay.textContent = 'Timer: ' + seconds;
                  }
              })
            .catch(error => console.error('Error:', error));
          }, 10000); // Fetch every 1000 milliseconds (1 second)
        })
      .catch(error => console.error('Error:', error));
    });
    </script>

  <script>
    async function getUserInfo() {
      const response = await fetch('/.auth/me');
      const payload = await response.json();
      const { clientPrincipal } = payload;
      return clientPrincipal;
    }

    (async () => {
    console.log(await getUserInfo());
    })();
  </script>

  <script src="https://alcdn.msauth.net/browser/2.17.0/js/msal-browser.min.js"></script>

  <script>

    const msalConfig = {
      auth: {
        clientId: "0f790682-c2d8-46d0-a22d-e5760fc93ff3",
        authority: "https://login.microsoftonline.com/6f5b157f-d392-4f88-8196-39c50f92b6c9",
        redirectUri: "https://avdgoldimage.az.trickyjoe.com/", // Your redirect URI
      },
      cache: {
        cacheLocation: "sessionStorage",
        storeAuthStateInCookie: false,
      },
    };

    const myMSALObj = new msal.PublicClientApplication(msalConfig);

    function acquireToken(account) {
      const request = {
        scopes: ["https://management.azure.com/user_impersonation"],
        account: account,
      };

      myMSALObj.acquireTokenSilent(request)
        .then((response) => {
          console.log("Access token:", response.accessToken);
          return response.accessToken;
          // Use the access token for API calls
        })
        .catch((error) => {
          console.error("Error acquiring token:", error);
        });
    }

    myMSALObj.loginPopup()
      .then((response) => {
        console.log("User signed in:", response);
        // Now you have an authenticated account object
        // Proceed to acquire tokens
        console.log('account is:', response.account)
        accessToken = acquireToken(response.account);
        // run the first fetch
        //todo - tidy up the order of execution, definition and nesting of functions.
        caller(accessToken);
      })
      .catch((error) => {
        console.error("Error signing in:", error);
      });

    var VMselect = document.getElementById("VMselector");
    var Galleryselect = document.getElementById("Galleryselector");
    var Definitionselect = document.getElementById("Definitionselector");
    var json = {};

    async function getJSON(accessToken) {
      //return fetch('/api/functiongoldvmlookup?code=-NDHm5KN9nSMCP05r_ywzQQNHPlxIDM79He5jWrdZs8uAzFu3gr3rw==')
      return fetch('/api/functiongoldvmlookup?code=blahblahblah', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ accessToken }),
      })
        .then(function (response) {
            return response.json();
        })
        .then(function (data) {
            return data;
        })
        .catch(function (err) {
            console.log('error: ' + err);
        });
      }

      async function caller(accessToken) {
        json = await this.getJSON(accessToken);
        console.log(JSON.stringify(json)); //check the object has come down
        appendData(json);
        updateDefinitions(Galleryselect.value);
        Galleryselect.addEventListener('change', function(){
          Definitionselect.innerText = null;
          let gallery = this.value
          console.log(gallery);
          console.log('listof defs:' + json.Galleries[gallery].Definitions.Name)
          updateDefinitions(gallery);
        });
      }

      function updateDefinitions(data) {
        for(var i = 0; i < json.Galleries[data].Definitions.length; i++)
          {
            console.log(json.Galleries[data].Definitions[i].Name);
            let option = document.createElement("option");
            option.value = i;
            option.textContent = json.Galleries[data].Definitions[i].Name;
            Definitionselect.appendChild(option);
          }
      }

      function appendData(data) {
          for(var i = 0; i < data.VMs.length; i++)
          {
            let option = document.createElement("option");
            option.value = i;
            option.textContent = data.VMs[i].Name;
            VMselect.appendChild(option);
          }
          for(var i = 0; i < data.Galleries.length; i++)
          {
            let option = document.createElement("option");
            option.value = i;
            option.textContent = data.Galleries[i].Name;
            Galleryselect.appendChild(option);
            console.log('defs:' + data.Galleries[i].Definitions.Name);
          }
      }
      
  </script>

  </main>
</body>

</html>
